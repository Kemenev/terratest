#cloud-config
packages:
  - lvm2

runcmd:

%{ for disk2 in extend_lvm ~}
  - parted /dev/sda --script resizepart 3  # Расширение партиции до полного размера диска
  - sleep 2  # Пауза для завершения parted
  - pvresize /dev/sda3  # Расширение физического тома
  - lvextend -l +100%FREE /dev/${disk2.vg}/${disk2.lv}  # Расширение LV
  - resize2fs /dev/${disk2.vg}/${disk2.lv}  # Расширение файловой системы
%{ endfor ~}

  # Глобальная пауза и стабилизация устройств перед обработкой доп. дисков
  - sleep 10
  - udevadm trigger
  - udevadm settle --timeout=60

%{ for disk in extra_disk ~}
  - parted /dev/sd${disk.disk_letter} --script mklabel gpt mkpart primary ext4 0% 100%
  - sleep 2
  - pvcreate /dev/sd${disk.disk_letter}1
  - vgcreate ${disk.vg} /dev/sd${disk.disk_letter}1
  - lvcreate -l 100%FREE -n ${disk.lv} ${disk.vg}
  - mkfs.ext4 /dev/${disk.vg}/${disk.lv}
  - mkdir -p ${disk.mount}
  - mount /dev/${disk.vg}/${disk.lv} ${disk.mount}
  - grep "/dev/${disk.vg}/${disk.lv}" /etc/fstab || echo "/dev/${disk.vg}/${disk.lv} ${disk.mount} ext4 defaults 0 0" >> /etc/fstab
%{ endfor ~}

  - [ sh, -c, "echo 'Cloud-init finished LVM setup' >> /var/log/cloud-init-debug.log" ]



