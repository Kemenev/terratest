data.netbox_prefix.subnet["vm-test-copydev"]
data.netbox_prefix.subnet["vm-test-copydev-copy"]
data.netbox_tenant.tenant["vm-test-copydev"]
data.netbox_tenant.tenant["vm-test-copydev-copy"]
data.netbox_tenant_group.group["vm-test-copydev"]
data.netbox_tenant_group.group["vm-test-copydev-copy"]
data.vsphere_compute_cluster.cl_sand["vm-test-copydev"]
data.vsphere_compute_cluster.cl_sand["vm-test-copydev-copy"]
data.vsphere_datacenter.dc_sand["sand-dtc-01"]
data.vsphere_datastore.ds_sand["vm-test-copydev"]
data.vsphere_datastore.ds_sand["vm-test-copydev-copy"]
data.vsphere_network.net_sand["vm-test-copydev"]
data.vsphere_network.net_sand["vm-test-copydev-copy"]
data.vsphere_storage_policy.pol_sand["01 NDR Storage Policy Thin"]
data.vsphere_virtual_machine.tpl_sand["vm-test-copydev"]
data.vsphere_virtual_machine.tpl_sand["vm-test-copydev-copy"]
netbox_available_ip_address.auto_ip["vm-test-copydev"]
netbox_available_ip_address.auto_ip["vm-test-copydev-copy"]
netbox_ip_address.ip["vm-test-copydev"]
netbox_ip_address.ip["vm-test-copydev-copy"]
vsphere_virtual_machine.vm_sand["vm-test-copydev"]
vsphere_virtual_machine.vm_sand["vm-test-copydev-copy"]
  # vsphere_virtual_machine.vm_sand["vm-test-copydev-copy"] will be created
- |
  grep 'vsphere_virtual_machine' tfplan.txt | grep -E 'will be created|will be replaced|must be replaced|destroyed and then created' \
    | sed -E 's/^.*# *//; s/ will be created$//; s/ will be replaced$//; s/ must be replaced$//; s/ destroyed and then created$//' \
    | sort -u > creates_in_plan.txt || true

  grep -Fx -f state_before.txt creates_in_plan.txt > recreates_from_state.txt || true

  if [ -s recreates_from_state.txt ]; then
    echo "ERROR: Terraform пытается пересоздать существующие VM"
    cat recreates_from_state.txt
    exit 1
  fi


